#!/bin/bash

spark_version='3.0.1'
hadoop_version='2.7'
image_name='docker.io/e8kor/apache-spark'
image_tag="$spark_version"
spark_release_name="spark-$spark_version-bin-hadoop$hadoop_version"
spark_archive_name="${spark_release_name}.tgz"

mkdir -p binary && mkdir -p temp 

if [[ ! -f "temp/$spark_archive_name" ]]; then
    echo "downloading spark $spark_version"
    curl https://apache.mirrors.tworzy.net/spark/spark-$spark_version/$spark_archive_name --output ./temp/$spark_archive_name
fi

if [[ ! -d "binary/$spark_release_name" ]]; then
    echo "unzipping spark binary $spark_version"
    tar -xzf temp/$spark_archive_name -C ./binary
fi

echo "building spark $spark_version image"
export ARCHS='--platform linux/arm64,linux/arm --load'; ./binary/$spark_release_name/bin/docker-image-tool.sh -X -r $image_name -t $image_tag -b java_image_tag=11 -f ./Dockerfile build

echo "pushing spark $spark_version image"
docker tag e8kor/apache-spark/spark:$image_tag $image_name:$image_tag \
&& docker push $image_name:$image_tag 
